# 开发环境 Dockerfile，支持热更新

# 使用 Python 3.11 作为基础镜像
FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 替换国内源并安装必要软件
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \
    sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \
    apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# 安装 Node.js 20 (用于前端开发)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs

# 配置 npm 国内镜像源
RUN npm config set registry https://registry.npmmirror.com

# 安装 Python 依赖
COPY backend/requirements.txt ./backend/requirements.txt
RUN pip install --no-cache-dir -r backend/requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 创建笔记目录
RUN mkdir -p /app/notes

# 暴露端口
EXPOSE 5173 8000

# 设置环境变量
ENV PYTHONUNBUFFERED=1
ENV NOTES_DIR=/app/notes

# 复制启动脚本
COPY docker-dev-entrypoint.sh /docker-dev-entrypoint.sh
RUN chmod +x /docker-dev-entrypoint.sh

# 启动开发服务器
ENTRYPOINT ["/docker-dev-entrypoint.sh"]

# 使用方式：
# 构建开发环境镜像
# docker build -f Dockerfile.dev -t mdxy-dev .

# 运行开发环境容器（支持代码热更新）
# docker run -d --name mdxy-dev -p 5173:5173 -p 8000:8000 -v $(pwd):/app mdxy-dev

# 查看启动日志
# docker logs -f mdxy-dev

# 停止容器
# docker stop mdxy-dev
# docker rm mdxy-dev